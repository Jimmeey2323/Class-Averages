<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Physique 57 Data Fetch</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    #loader {
      display: none;
      border: 16px solid #f3f3f3;
      border-radius: 50%;
      border-top: 16px solid #3498db;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
      margin: 0 auto;
      margin-top: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      color: red;
      text-align: center;
    }
    #data-table {
      display: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Fetch Recurring Class Data</h1>

  <div id="form-section">
    <label for="center">Select Center:</label>
    <select id="center">
      <option value="Supreme HQ, Bandra">Supreme HQ, Bandra</option>
      <option value="Kwality House, Kemps Corner">Kwality House, Kemps Corner</option>
      <option value="Kenkere House, Bengaluru">Kenkere House, Bengaluru</option>
      <option value="All Centers">All Centers</option>
    </select>

    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate" required>

    <label for="endDate">End Date:</label>
    <input type="date" id="endDate" required>

    <button onclick="fetchData()">Fetch Data</button>
  </div>

  <div id="loader"></div>

  <div class="error" id="error-message"></div>

  <table id="data-table" class="display">
    <thead>
      <tr>
        <th>ID</th>
        <th>Genesis ID</th>
        <th>Session Name</th>
        <th>Date</th>
        <th>Time</th>
        <th>Location</th>
        <th>Bookings</th>
        <th>Visits</th>
        <th>Teacher Name</th>
        <th>Month</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>

  <script>
    const loginUrl = 'https://api.momence.com/auth/login';
    const email = 'jimmeey@physique57india.com';
    const password = 'Jimmeey@123';

    function showLoader(show) {
      document.getElementById('loader').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      document.getElementById('error-message').innerText = message;
    }

    function fetchData() {
      const center = document.getElementById('center').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!startDate || !endDate) {
        showError('Please select a valid date range.');
        return;
      }

      showError('');
      showLoader(true);

      authenticate(loginUrl, email, password).then(cookie => {
        if (!cookie) {
          showError('Failed to authenticate.');
          showLoader(false);
          return;
        }

        fetchRData(center, startDate, endDate, cookie);
      }).catch(err => {
        showError('Error during authentication: ' + err.message);
        showLoader(false);
      });
    }

    function authenticate(loginUrl, email, password) {
  const loginHeaders = {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  };

  const loginPayload = {
    email: email,
    password: password,
  };

  return fetch(loginUrl, {
    method: 'POST',
    headers: loginHeaders,
    body: JSON.stringify(loginPayload),
  })
  .then(response => {
    const cookie = response.headers.get('Set-Cookie');
    return cookie ? cookie.split(';')[0] : null; // Extract session cookie
  })
  .catch(error => {
    console.error('Error during authentication:', error.message);
    return null;
  });
}

    function fetchRData(center, startDate, endDate, cookie) {
      const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Cookie': cookie,
      };

      const params = {
        startDate: new Date(startDate).toISOString(),
        endDate: new Date(endDate).toISOString(),
      };

      const locations = {
        'Supreme HQ, Bandra': 29821,
        'Kwality House, Kemps Corner': 9030,
        'Kenkere House, Bengaluru': 22116
      };

      let url = '';

      if (center === 'All Centers') {
        url = `https://api.momence.com/host/13752/reports/recurring-event-attendance?startDate=${params.startDate}&endDate=${params.endDate}`;
      } else if (locations[center]) {
        url = `https://api.momence.com/host/13752/reports/recurring-event-attendance?startDate=${params.startDate}&endDate=${params.endDate}&locationId=${locations[center]}`;
      } else {
        showError('Invalid center.');
        showLoader(false);
        return;
      }

      fetch(url, { headers })
        .then(response => response.json())
        .then(data => {
          populateTable(data.items || data.reportData.items || []);
          showLoader(false);
        })
        .catch(err => {
          showError('Error fetching data: ' + err.message);
          showLoader(false);
        });
    }

    function populateTable(data) {
      const table = $('#data-table').DataTable();
      table.clear();

      if (data.length === 0) {
        showError('No data found for the selected range.');
        return;
      }

      data.forEach(item => {
        const { id, genesisId, sessionName, startsAt, locationName, bookingsCount, visitsCount, teacherName } = item;
        const [datePart, timePart] = convertToIST(startsAt);
        const monthName = new Date(startsAt).toLocaleString('default', { month: 'short' });

        table.row.add([id, genesisId, sessionName, datePart, timePart, locationName, bookingsCount, visitsCount, teacherName, monthName]).draw();
      });

      document.getElementById('data-table').style.display = 'block';
    }

    function convertToIST(dateString) {
      const date = new Date(dateString);
      const istDate = new Intl.DateTimeFormat('en-IN', { dateStyle: 'short' }).format(date);
      const istTime = new Intl.DateTimeFormat('en-IN', { timeStyle: 'short' }).format(date);
      return [istDate, istTime];
    }
  </script>

</body>
</html>
